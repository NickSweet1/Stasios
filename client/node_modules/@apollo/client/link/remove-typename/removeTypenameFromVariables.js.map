{"version":3,"file":"removeTypenameFromVariables.js","sourceRoot":"","sources":["../../../src/link/remove-typename/removeTypenameFromVariables.ts"],"names":[],"mappings":"AAAA,OAAO,EAAE,IAAI,EAAE,MAAM,UAAU,CAAC;AAEhC,OAAO,EAAE,IAAI,EAAE,KAAK,EAAE,MAAM,SAAS,CAAC;AACtC,OAAO,EAAE,UAAU,EAAE,MAAM,kBAAkB,CAAC;AAC9C,OAAO,EAAE,aAAa,EAAE,aAAa,EAAE,MAAM,0BAA0B,CAAC;AAGxE,MAAM,CAAC,IAAM,IAAI,GAAG,QAAQ,CAAC;AAU7B,MAAM,UAAU,2BAA2B,CACzC,OAAiE;IAAjE,wBAAA,EAAA,UAA8C,MAAM,CAAC,MAAM,CAAC,IAAI,CAAC;IAEjE,OAAO,IAAI,UAAU,CAAC,UAAC,SAAS,EAAE,OAAO;QAC/B,IAAA,MAAM,GAAK,OAAO,OAAZ,CAAa;QACnB,IAAA,KAAK,GAAgB,SAAS,MAAzB,EAAE,SAAS,GAAK,SAAS,UAAd,CAAe;QAEvC,IAAI,SAAS,EAAE;YACb,SAAS,CAAC,SAAS,GAAG,MAAM;gBAC1B,CAAC,CAAC,6BAA6B,CAAC,KAAK,EAAE,SAAS,EAAE,MAAM,CAAC;gBACzD,CAAC,CAAC,aAAa,CAAC,SAAS,CAAC,CAAC;SAC9B;QAED,OAAO,OAAO,CAAC,SAAS,CAAC,CAAC;IAC5B,CAAC,CAAC,CAAC;AACL,CAAC;AAED,SAAS,6BAA6B,CACpC,KAAmB,EACnB,SAA6B,EAC7B,MAA0B;IAE1B,IAAM,mBAAmB,GAAG,sBAAsB,CAAC,KAAK,CAAC,CAAC;IAE1D,OAAO,MAAM,CAAC,WAAW,CACvB,MAAM,CAAC,OAAO,CAAC,SAAS,CAAC,CAAC,GAAG,CAAC,UAAC,MAAM;QAC5B,IAAA,GAAG,GAAW,MAAM,GAAjB,EAAE,KAAK,GAAI,MAAM,GAAV,CAAW;QAC5B,IAAM,QAAQ,GAAG,mBAAmB,CAAC,GAAG,CAAC,CAAC;QAC1C,IAAM,cAAc,GAAG,MAAM,CAAC,QAAQ,CAAC,CAAC;QAExC,MAAM,CAAC,CAAC,CAAC,GAAG,cAAc;YACxB,CAAC,CAAC,kBAAkB,CAAC,KAAK,EAAE,cAAc,CAAC;YAC3C,CAAC,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAEzB,OAAO,MAAM,CAAC;IAChB,CAAC,CAAC,CACH,CAAC;AACJ,CAAC;AAKD,SAAS,kBAAkB,CACzB,KAAgB,EAChB,MAAkC;IAElC,IAAI,MAAM,KAAK,IAAI,EAAE;QACnB,OAAO,KAAK,CAAC;KACd;IAED,IAAI,KAAK,CAAC,OAAO,CAAC,KAAK,CAAC,EAAE;QACxB,OAAO,KAAK,CAAC,GAAG,CAAC,UAAC,IAAI,IAAK,OAAA,kBAAkB,CAAC,IAAI,EAAE,MAAM,CAAC,EAAhC,CAAgC,CAAC,CAAC;KAC9D;IAED,IAAI,aAAa,CAAC,KAAK,CAAC,EAAE;QACxB,IAAM,UAAQ,GAAwB,EAAE,CAAC;QAEzC,MAAM,CAAC,IAAI,CAAC,KAAK,CAAC,CAAC,OAAO,CAAC,UAAC,GAAG;YAC7B,IAAM,KAAK,GAAG,KAAK,CAAC,GAAG,CAAC,CAAC;YAEzB,IAAI,GAAG,KAAK,YAAY,EAAE;gBACxB,OAAO;aACR;YAED,IAAM,WAAW,GAAG,MAAM,CAAC,GAAG,CAAC,CAAC;YAEhC,UAAQ,CAAC,GAAG,CAAC,GAAG,WAAW;gBACzB,CAAC,CAAC,kBAAkB,CAAC,KAAK,EAAE,WAAW,CAAC;gBACxC,CAAC,CAAC,aAAa,CAAC,KAAK,CAAC,CAAC;QAC3B,CAAC,CAAC,CAAC;QAEH,OAAO,UAAQ,CAAC;KACjB;IAED,OAAO,KAAK,CAAC;AACf,CAAC;AAED,IAAM,sBAAsB,GAAG,IAAI,CAAC,UAAC,QAAsB;IACzD,IAAM,WAAW,GAA2B,EAAE,CAAC;IAE/C,KAAK,CAAC,QAAQ,EAAE;QACd,kBAAkB,YAAC,IAAI;YACrB,WAAW,CAAC,IAAI,CAAC,QAAQ,CAAC,IAAI,CAAC,KAAK,CAAC,GAAG,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAChE,CAAC;KACF,CAAC,CAAC;IAEH,OAAO,WAAW,CAAC;AACrB,CAAC,CAAC,CAAC;AAEH,SAAS,UAAU,CAAC,IAAc;IAChC,QAAQ,IAAI,CAAC,IAAI,EAAE;QACjB,KAAK,IAAI,CAAC,aAAa;YACrB,OAAO,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC/B,KAAK,IAAI,CAAC,SAAS;YACjB,OAAO,UAAU,CAAC,IAAI,CAAC,IAAI,CAAC,CAAC;QAC/B,KAAK,IAAI,CAAC,UAAU;YAClB,OAAO,IAAI,CAAC,IAAI,CAAC,KAAK,CAAC;KAC1B;AACH,CAAC","sourcesContent":["import { wrap } from \"optimism\";\nimport type { DocumentNode, TypeNode } from \"graphql\";\nimport { Kind, visit } from \"graphql\";\nimport { ApolloLink } from \"../core/index.js\";\nimport { stripTypename, isPlainObject } from \"../../utilities/index.js\";\nimport type { OperationVariables } from \"../../core/index.js\";\n\nexport const KEEP = \"__KEEP\";\n\ninterface KeepTypenameConfig {\n  [key: string]: typeof KEEP | KeepTypenameConfig;\n}\n\nexport interface RemoveTypenameFromVariablesOptions {\n  except?: KeepTypenameConfig;\n}\n\nexport function removeTypenameFromVariables(\n  options: RemoveTypenameFromVariablesOptions = Object.create(null)\n) {\n  return new ApolloLink((operation, forward) => {\n    const { except } = options;\n    const { query, variables } = operation;\n\n    if (variables) {\n      operation.variables = except\n        ? maybeStripTypenameUsingConfig(query, variables, except)\n        : stripTypename(variables);\n    }\n\n    return forward(operation);\n  });\n}\n\nfunction maybeStripTypenameUsingConfig(\n  query: DocumentNode,\n  variables: OperationVariables,\n  config: KeepTypenameConfig\n) {\n  const variableDefinitions = getVariableDefinitions(query);\n\n  return Object.fromEntries(\n    Object.entries(variables).map((keyVal) => {\n      const [key, value] = keyVal;\n      const typename = variableDefinitions[key];\n      const typenameConfig = config[typename];\n\n      keyVal[1] = typenameConfig\n        ? maybeStripTypename(value, typenameConfig)\n        : stripTypename(value);\n\n      return keyVal;\n    })\n  );\n}\n\ntype JSONPrimitive = string | number | null | boolean;\ntype JSONValue = JSONPrimitive | JSONValue[] | { [key: string]: JSONValue };\n\nfunction maybeStripTypename(\n  value: JSONValue,\n  config: KeepTypenameConfig[string]\n): JSONValue {\n  if (config === KEEP) {\n    return value;\n  }\n\n  if (Array.isArray(value)) {\n    return value.map((item) => maybeStripTypename(item, config));\n  }\n\n  if (isPlainObject(value)) {\n    const modified: Record<string, any> = {};\n\n    Object.keys(value).forEach((key) => {\n      const child = value[key];\n\n      if (key === \"__typename\") {\n        return;\n      }\n\n      const fieldConfig = config[key];\n\n      modified[key] = fieldConfig\n        ? maybeStripTypename(child, fieldConfig)\n        : stripTypename(child);\n    });\n\n    return modified;\n  }\n\n  return value;\n}\n\nconst getVariableDefinitions = wrap((document: DocumentNode) => {\n  const definitions: Record<string, string> = {};\n\n  visit(document, {\n    VariableDefinition(node) {\n      definitions[node.variable.name.value] = unwrapType(node.type);\n    },\n  });\n\n  return definitions;\n});\n\nfunction unwrapType(node: TypeNode): string {\n  switch (node.kind) {\n    case Kind.NON_NULL_TYPE:\n      return unwrapType(node.type);\n    case Kind.LIST_TYPE:\n      return unwrapType(node.type);\n    case Kind.NAMED_TYPE:\n      return node.name.value;\n  }\n}\n"]}